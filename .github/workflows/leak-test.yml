name: Leak Test - mmaplist chunks

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  valgrind-leak-test:
    name: Valgrind Before/After Fix
    runs-on: ubuntu-24.04-arm

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git file valgrind
        sudo apt-get install -y gcc-x86-64-linux-gnu

    - name: Build test binary and shared library
      run: |
        mkdir -p bin
        make -C 003_mmaplist_chunks_leak BIN_DIR=../bin CC=x86_64-linux-gnu-gcc
        echo "=== Built artifacts ==="
        file bin/003_mmaplist_chunks_leak bin/libhot.so

    # ── BEFORE FIX ──────────────────────────────────────────────
    - name: Build Box64 (BEFORE fix - upstream main)
      run: |
        git clone --depth 1 https://github.com/ptitSeb/box64.git /tmp/box64-before
        cd /tmp/box64-before
        mkdir build && cd build
        cmake .. -D ARM_DYNAREC=ON -D CMAKE_BUILD_TYPE=RelWithDebInfo
        make -j$(nproc)
        sudo make install

    - name: Valgrind BEFORE fix
      run: |
        echo "============================================"
        echo " BEFORE FIX: Expecting chunks leak"
        echo "============================================"
        cd bin
        valgrind --leak-check=full \
                 --show-leak-kinds=definite,indirect \
                 --track-origins=yes \
                 --num-callers=20 \
                 box64 ./003_mmaplist_chunks_leak 100 \
                 2>&1 | tee /tmp/valgrind_before.txt

        echo ""
        echo "=== LEAK SUMMARY (BEFORE FIX) ==="
        grep -E "(definitely|indirectly) lost" /tmp/valgrind_before.txt || echo "No standard leak line found"
        echo ""
        echo "=== Leak details related to realloc/Mmaplist ==="
        grep -B 2 -A 10 "realloc\|Mmaplist\|MmaplistAdd" /tmp/valgrind_before.txt || echo "No Mmaplist-related leaks found"

    # NOTE: The 003 patch has been merged into upstream (ptitSeb/box64).
    # The fix (box_free(list->chunks)) is already in main.
    # This workflow now just verifies that the leak is gone in upstream.

    - name: Upload valgrind log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: valgrind-logs
        path: /tmp/valgrind_before.txt
        retention-days: 30
