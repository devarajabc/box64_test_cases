name: Test Box64

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      use_qemu:
        description: 'Force QEMU instead of ARM64 runner'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Primary: Use GitHub ARM64 runner (fast, for public repos)
  test-arm64-runner:
    name: ARM64 Runner
    runs-on: ubuntu-24.04-arm
    if: ${{ github.event.inputs.use_qemu != 'true' }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git file

    - name: Install cross-compilers
      run: |
        sudo apt-get install -y gcc-x86-64-linux-gnu g++-x86-64-linux-gnu
        sudo apt-get install -y gcc-i686-linux-gnu g++-i686-linux-gnu

    - name: Build tests
      run: |
        mkdir -p bin
        # Build 64-bit tests
        make -C 001_fork_in_used_leak BIN_DIR=../bin CC=x86_64-linux-gnu-gcc
        # Build 32-bit test (002 needs 32-bit for the braces bug)
        make -C 002_0f00_missing_braces BIN_DIR=../bin CC=i686-linux-gnu-gcc

    - name: Verify binaries
      run: |
        echo "=== Binary types ==="
        file bin/*

    - name: Build Box64 with Box32 support
      run: |
        git clone --depth 1 --branch CHECK_WOWO https://github.com/devarajabc/box64.git /tmp/box64
        cd /tmp/box64
        mkdir build && cd build
        cmake .. -D ARM_DYNAREC=ON -D CMAKE_BUILD_TYPE=RelWithDebInfo -D BOX32=ON
        make -j$(nproc)
        sudo make install

    - name: Run 64-bit test (interpreter)
      run: |
        echo "=== 64-bit test: BOX64_DYNAREC=0 ==="
        BOX64_DYNAREC=0 box64 bin/001_fork_in_used_leak || echo "EXIT CODE: $?"

    - name: Run 64-bit test (dynarec)
      run: |
        echo "=== 64-bit test: BOX64_DYNAREC=1 ==="
        BOX64_DYNAREC=1 box64 bin/001_fork_in_used_leak || echo "EXIT CODE: $?"

    - name: Run 32-bit test (interpreter)
      run: |
        echo "=== 32-bit test: BOX64_DYNAREC=0 ==="
        BOX64_DYNAREC=0 box64 bin/002_0f00_missing_braces || echo "EXIT CODE: $?"

    - name: Run 32-bit test (dynarec)
      run: |
        echo "=== 32-bit test: BOX64_DYNAREC=1 ==="
        BOX64_DYNAREC=1 box64 bin/002_0f00_missing_braces || echo "EXIT CODE: $?"

  # Fallback: Use QEMU on x86_64 runner (slower, always available)
  test-qemu-fallback:
    name: QEMU Fallback
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.use_qemu == 'true' || failure() }}
    needs: [test-arm64-runner]

    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Build and test in ARM64 container
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          arm64v8/ubuntu:22.04 \
          bash -c '
            set -e
            echo "=== Setting up environment ==="
            apt-get update
            apt-get install -y build-essential cmake git file
            apt-get install -y gcc-x86-64-linux-gnu gcc-i686-linux-gnu

            echo "=== Building test binaries ==="
            mkdir -p bin
            make -C 001_fork_in_used_leak BIN_DIR=../bin CC=x86_64-linux-gnu-gcc
            make -C 002_0f00_missing_braces BIN_DIR=../bin CC=i686-linux-gnu-gcc
            file bin/*

            echo "=== Building Box64 with Box32 ==="
            git clone --depth 1 --branch CHECK_WOWO https://github.com/devarajabc/box64.git /tmp/box64
            cd /tmp/box64
            mkdir build && cd build
            cmake .. -D ARM_DYNAREC=ON -D CMAKE_BUILD_TYPE=RelWithDebInfo -D BOX32=ON
            make -j$(nproc)
            make install
            cd /workspace

            echo ""
            echo "=== Running 32-bit test (interpreter) ==="
            BOX64_DYNAREC=0 box64 bin/002_0f00_missing_braces || echo "EXIT CODE: $?"

            echo ""
            echo "=== Running 32-bit test (dynarec) ==="
            BOX64_DYNAREC=1 box64 bin/002_0f00_missing_braces || echo "EXIT CODE: $?"
          '
